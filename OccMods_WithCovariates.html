<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Deon Roos">
<meta name="dcterms.date" content="2025-05-03">

<title>Occupancy Modelling - Including Covariates in Occupancy Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.33/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Occupancy Modelling</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./Occupancy_Models.html" rel="" target="">
 <span class="menu-text">Occupancy Models: The basics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./OccMods_WithCovariates.html" rel="" target="" aria-current="page">
 <span class="menu-text">Occupancy Models: Covariates</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Bayesian_Statistics.html" rel="" target="">
 <span class="menu-text">Bayesian models: The concept</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Bayesian_Occupancy_Models.html" rel="" target="">
 <span class="menu-text">Fitting Bayesian Models</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#the-theory" id="toc-the-theory" class="nav-link active" data-scroll-target="#the-theory">The theory</a>
  <ul class="collapse">
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  <li><a href="#interpreting" id="toc-interpreting" class="nav-link" data-scroll-target="#interpreting">Interpreting</a></li>
  <li><a href="#plot-predicted-relationships" id="toc-plot-predicted-relationships" class="nav-link" data-scroll-target="#plot-predicted-relationships">Plot predicted relationships</a></li>
  <li><a href="#uncertainty" id="toc-uncertainty" class="nav-link" data-scroll-target="#uncertainty">Uncertainty</a></li>
  </ul></li>
  <li><a href="#multiple-covariates" id="toc-multiple-covariates" class="nav-link" data-scroll-target="#multiple-covariates">Multiple covariates</a>
  <ul class="collapse">
  <li><a href="#data-preparation-1" id="toc-data-preparation-1" class="nav-link" data-scroll-target="#data-preparation-1">Data preparation</a></li>
  <li><a href="#fitting-the-model-1" id="toc-fitting-the-model-1" class="nav-link" data-scroll-target="#fitting-the-model-1">Fitting the model</a></li>
  <li><a href="#interpreting-the-results" id="toc-interpreting-the-results" class="nav-link" data-scroll-target="#interpreting-the-results">Interpreting the results</a></li>
  <li><a href="#diagnosing-potential-issues" id="toc-diagnosing-potential-issues" class="nav-link" data-scroll-target="#diagnosing-potential-issues">Diagnosing potential issues</a></li>
  <li><a href="#resolving-issues" id="toc-resolving-issues" class="nav-link" data-scroll-target="#resolving-issues">Resolving issues</a></li>
  <li><a href="#plot-predicted-relationships-1" id="toc-plot-predicted-relationships-1" class="nav-link" data-scroll-target="#plot-predicted-relationships-1">Plot predicted relationships</a></li>
  </ul></li>
  <li><a href="#how-should-i-store-my-data" id="toc-how-should-i-store-my-data" class="nav-link" data-scroll-target="#how-should-i-store-my-data">How should I store my data?</a>
  <ul class="collapse">
  <li><a href="#dataset-one-detection-history" id="toc-dataset-one-detection-history" class="nav-link" data-scroll-target="#dataset-one-detection-history">Dataset one: Detection history</a></li>
  <li><a href="#dataset-two-site-level-covariates" id="toc-dataset-two-site-level-covariates" class="nav-link" data-scroll-target="#dataset-two-site-level-covariates">Dataset two: Site-level covariates</a></li>
  <li><a href="#dataset-three-and-beyond-survey-level-covariates" id="toc-dataset-three-and-beyond-survey-level-covariates" class="nav-link" data-scroll-target="#dataset-three-and-beyond-survey-level-covariates">Dataset three (and beyond): Survey-level covariates</a></li>
  </ul></li>
  <li><a href="#what-next" id="toc-what-next" class="nav-link" data-scroll-target="#what-next">What next?</a></li>
  <li><a href="#lecture-recording" id="toc-lecture-recording" class="nav-link" data-scroll-target="#lecture-recording">Lecture recording</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Including Covariates in Occupancy Models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Deon Roos </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 3, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>On this page, we’ll start expanding on the intercept-only occupancy model from <em>Occupancy Models: The basics</em> by injecting some biology into our <code>etosha</code> elephant model.</p>
<p>As before, we’ll use <code>spOccupancy</code> to fit the model. For visualisation, we’ll also use <code>ggplot2</code> and <code>patchwork</code> (which lets you combine multiple ggplots into one).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spOccupancy)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="the-theory" class="level1">
<h1>The theory</h1>
<p>On the previous page, we introduced a simple occupancy model to understand the basic structure. Now, we’ll gradually increase the complexity—starting by adding covariates. These are also called <em>explanatory variables</em>, <em>independent variables</em>, or several other names (statistical terminology can be a mess).</p>
<p>Let’s revisit our simple occupancy model:</p>
<p><span class="math display">\[
z_i \sim \text{Bernoulli}(\psi_i)  \tag{State Stochastic}
\]</span></p>
<p><span class="math display">\[
logit(\psi_i) = \beta_0\\  \tag{State Deterministic}
\]</span></p>
<p><span class="math display">\[
y_{i,j} \sim Bernoulli(p_{i,j} \times z_i)\\  \tag{Observation Stochastic}
\]</span></p>
<p><span class="math display">\[
logit(p_{i,j}) = \alpha_0  \tag{Observation Deterministic}
\]</span></p>
<p>I’ve included the tags on the right to help distinguish the two types of equations. <em>Stochastic</em> refers to the parts of the model that deal with randomness. <em>Deterministic</em> refers to the parts that explain <em>why</em> something happens. The <em>state model</em> explains whether a species is present at a site, and the <em>observation model</em> explains whether we detect it.</p>
<p>In this section, we’ll start by adding covariates to the deterministic parts, arbitrarily starting with the <em>observation model</em>.</p>
<p>A quick reminder: <span class="math inline">\(y\)</span> is indexed by both <span class="math inline">\(i\)</span> (site) and <span class="math inline">\(j\)</span> (survey). This is important because it allows us to include covariates that vary by both site and survey, not just by site. For example:</p>
<ul>
<li>A site-level covariate might be: site 1 has 20 trees, site 2 has 10.</li>
<li>A survey-level covariate might be: at site 1, the temperature was 20°C in survey 1, 15°C in survey 2, and 5°C in survey 3.</li>
</ul>
<p>This means we can include variables that change across surveys, <em>as long as we measured and recorded them</em>.</p>
<p>These <em>survey-varying covariates</em> represent conditions that might affect how likely we are to detect the species. If you’re using cameras, maybe fog reduces detection. If you’re doing visual surveys, maybe time of day matters. These variables help us model the variables that affect detection probability.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/fog.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">A photo taken after some unseen animal triggered the motion sensor on a foggy day.</figcaption>
</figure>
</div>
<p>I’ll simulate a new dataset with a bit more data to work with: 64 sites, each surveyed three times. This time, I’ll include a detection covariate; <em>rainfall</em>.</p>
<p>Note that the values for rainfall are <em>centred on zero</em>. You don’t need to worry about the details for now - you don’t need to do this but you can if you want to. For now: the higher the value of <code>rain</code>, the more rainfall there was in that site, on that survey.</p>
<p>Here’s what the data looks like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">simOcc</span>(<span class="at">J.x =</span> <span class="dv">8</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">J.y =</span> <span class="dv">8</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.rep =</span> <span class="fu">rep</span>(<span class="dv">3</span>, <span class="at">times =</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">8</span>), </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">beta =</span> <span class="fu">c</span>(<span class="dv">1</span>), </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.5</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> dat<span class="sc">$</span>y</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>det_cov <span class="ot">&lt;-</span> dat<span class="sc">$</span>X.p[,,<span class="dv">2</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">survey =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="dv">64</span>),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">cov =</span> <span class="fu">c</span>(det_cov[,<span class="dv">1</span>], det_cov[,<span class="dv">2</span>], det_cov[,<span class="dv">3</span>]),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(obs[,<span class="dv">1</span>], obs[,<span class="dv">2</span>], obs[,<span class="dv">3</span>])</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(survey), <span class="at">y =</span> cov)) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(survey), <span class="at">y =</span> cov),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Survey"</span>, <span class="at">y =</span> <span class="st">"Rainfall"</span>) <span class="sc">+</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">factor</span>(y), <span class="at">x =</span> cov),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">height =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Rainfall"</span>, <span class="at">y =</span> <span class="st">"Elephant detection"</span>) <span class="sc">+</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>obs_long <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(obs)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(obs_long) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Survey_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(obs_long))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Site <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(obs_long)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>obs_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(obs_long, </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Survey"</span>), </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">names_to =</span> <span class="st">"Survey"</span>, </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">values_to =</span> <span class="st">"Detection"</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Survey <span class="ot">&lt;-</span> <span class="fu">factor</span>(obs_long<span class="sc">$</span>Survey, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"Survey_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(obs)))</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Detection <span class="ot">&lt;-</span> <span class="fu">factor</span>(obs_long<span class="sc">$</span>Detection, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Detection"</span>, <span class="st">"No detection"</span>))</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a> p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(obs_long, <span class="fu">aes</span>(<span class="at">x =</span> Site, <span class="at">y =</span> Survey, <span class="at">fill =</span> Detection)) <span class="sc">+</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Detection"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"No detection"</span> <span class="ot">=</span> <span class="st">"lightgrey"</span>)) <span class="sc">+</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Site"</span>, <span class="at">y =</span> <span class="st">"Survey"</span>) <span class="sc">+</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="st">AB</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="st">AB</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="st">CC</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>, <span class="at">tag_suffix =</span> <span class="st">")"</span>) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">design =</span> design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>A)</strong> shows the amount of rainfall across each survey. Each point represents a site in a given survey. <strong>B)</strong> shows rainfall plotted against whether or not an elephant was detected. <strong>C)</strong> shows the detection history, with detections coloured green and non-detections in grey.</p>
<p>Notice anything?</p>
<p>In <strong>A)</strong>, we can see that rainfall varies widely across the 64 sites in each survey, with a possible peak in survey 2.<br>
In <strong>B)</strong>, it looks like elephants might be detected more often when there’s more rainfall.<br>
In <strong>C)</strong>, we see that detections usually happen in just one survey per site, with no detection in the others. Remember the closure assumption; we assume that if elephants were detected once, they were present during all surveys at that site.</p>
<p>Now consider <strong>B)</strong> more carefully. How confident are you that rainfall influences detection probability? If you think it does, how strong is that effect? Can you say exactly <em>how</em> strong it is?</p>
<p>You probably can’t, and that’s where we need statistics.</p>
<p>Let’s add rainfall as a covariate in the model. I’ll reuse the basic model structure from the previous page but now include rainfall as a detection covariate.</p>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data preparation</h2>
<p>Just like on the previous page, we need to include our datasets in a <code>list</code>. If you’re still unsure what a <code>list</code> is in R, think of it like a folder on your computer. You can add lots of different files to a folder—any type of file—and they’re all “tied together” by being in the same place. A <code>list</code> in R works the same way.</p>
<p>The complication now is that I have <em>two</em> datasets. One for my detection history matrix and another for the <em>rain</em> covariate. To include both, I’m going to do something that might seem a little strange at first. I’ll create a <code>list</code> for the detection covariate and then include that list inside our main <code>etosha</code> list. That gives us a list <em>within</em> a list.</p>
<p>Why? Because we might want to add more than one detection covariate later. Even though it feels redundant now, this structure makes it easier to expand the model in the future.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note you wouldn't need to do the dat$X.p[,,2] bit</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># That's just because the data is simulated.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>det.covs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">rain =</span> dat<span class="sc">$</span>X.p[,,<span class="dv">2</span>])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>etosha <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> dat<span class="sc">$</span>y,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">det.covs =</span> det.covs</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And with that, we’re ready to move on to modelling.</p>
</section>
<section id="fitting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h2>
<p>Here are a few things to note about the model specification:</p>
<ul>
<li><p><code>occ.formula = ~ 1</code> corresponds to the equation<br>
<span class="math display">\[
\text{logit}(\psi_i) = \beta_0
\]</span><br>
This is an intercept-only occupancy model, meaning we are not including any covariates for the probability that a site is occupied.</p></li>
<li><p><code>det.formula = ~ rain</code> corresponds to the equation<br>
<span class="math display">\[
\text{logit}(p_i) = \alpha_0 + \alpha_1 \times \text{Rain}_i
\]</span><br>
This means we are modelling detection probability as a function of rainfall. The model includes both an intercept (<span class="math inline">\(\alpha_0\)</span>) and a slope for rain (<span class="math inline">\(\alpha_1\)</span>).</p></li>
<li><p>We specify that all the data needed for the model is contained in the list called <code>etosha</code> (think of it like a folder that holds everything in one place).</p></li>
<li><p>The remaining arguments (such as <code>n.chains</code>) control how the Bayesian model is run. You can ignore these for now.</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">PGOcc</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The state model (i.e. what % that elephants are present?)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ~ 1 means we want an intercept only model (no covariates)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">occ.formula =</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The observation model (i.e. what % that we see elephants if present?)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">det.formula =</span> <span class="sc">~</span> rain, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Our carefully formatted dataset</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> etosha, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Details to get the machinery to run that we'll ignore for now</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.chains =</span> <span class="dv">4</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">2000</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.burn =</span> <span class="dv">200</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="interpreting" class="level2">
<h2 class="anchored" data-anchor-id="interpreting">Interpreting</h2>
<p>Now that we’ve fit the model to the data, we can see what we’ve learned.</p>
<p>Compared to the model on the previous page, we now have additional output under <code>Detection (logit scale)</code>. Specifically, we have estimates for both <code>(Intercept)</code> and <code>rain</code>. These correspond to <span class="math inline">\(\alpha_0\)</span> and <span class="math inline">\(\alpha_1\)</span> in our detection model:</p>
<p><span class="math display">\[
\text{logit}(p_i) = \alpha_0 + \alpha_1 \times \text{Rain}_i
\]</span></p>
<p>If we want, we can substitute in the estimated values (rounded to two decimal places) and rewrite the model like this:</p>
<p><span class="math display">\[
z_i \sim \text{Bernoulli}(\psi_i) \tag{State Stochastic}
\]</span></p>
<p><span class="math display">\[
\text{logit}(\psi_i) = 1.88 \tag{State Deterministic}
\]</span></p>
<p><span class="math display">\[
y_{i,j} \sim \text{Bernoulli}(p_{i,j} \times z_i) \tag{Observation Stochastic}
\]</span></p>
<p><span class="math display">\[
\text{logit}(p_{i,j}) = -1.89 + 0.69 \times \text{Rain}_i \tag{Observation Deterministic}
\]</span></p>
<p>This final equation lets us calculate detection probabilities for different rainfall values. For example, when <span class="math inline">\(\text{Rain} = 1\)</span> (which corresponds to heavy rainfall in this dataset), we get:</p>
<p><span class="math display">\[
\text{logit}(p) = -1.89 + 0.69 \times 1 = -1.2
\]</span></p>
<p>To convert this logit value back to a probability, we apply the inverse logit (also called the logistic function):</p>
<p><span class="math display">\[
p = \frac{1}{1 + \exp(-(-1.20))} = \frac{1}{1 + \exp(1.20)} = 0.23 = 23\%
\]</span></p>
<p>Or we could just do <code>plogis(-1.89 + 0.69 * 1)</code>.</p>
<p>When <span class="math inline">\(Rain = 0\)</span> (moderate rainfall), the logit becomes -1.89, which converts to a detection probability of about 13%.</p>
<p>This process, whereby we plug in a covariate value to make a prediction, is something we can repeat for many values of <code>rain</code>. Doing so allows us to build the predicted relationship that shows how detection probability changes with rainfall.</p>
<p>Next, we’ll create that prediction curve and visualise the effect of rainfall on detection.</p>
</section>
<section id="plot-predicted-relationships" class="level2">
<h2 class="anchored" data-anchor-id="plot-predicted-relationships">Plot predicted relationships</h2>
<p>To visualise the relationship between rainfall and detection probability, we first create a sequence of <code>Rain</code> values. Rather than calculating one at a time as we just did, we’ll use the <code>seq()</code> function to generate a smooth range of values between the minimum and maximum rainfall in our dataset. Here, we use 20 points to draw a smooth line, but you could choose any number depending on the level of detail you want.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>rain <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(det.covs<span class="sc">$</span>rain),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">to =</span> <span class="fu">max</span>(det.covs<span class="sc">$</span>rain),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">length.out =</span> <span class="dv">20</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>rain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -2.71815687 -2.44127881 -2.16440076 -1.88752271 -1.61064465 -1.33376660
 [7] -1.05688855 -0.78001049 -0.50313244 -0.22625439  0.05062367  0.32750172
[13]  0.60437977  0.88125783  1.15813588  1.43501393  1.71189199  1.98877004
[19]  2.26564809  2.54252615</code></pre>
</div>
</div>
<p>Now that we have our sequence of rainfall values, we want to calculate the predicted detection probability for each one. Because <code>R</code> works with vectors (columns of values), we can apply our model equation to the entire sequence in one step.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.89</span> <span class="sc">+</span> <span class="fl">0.69</span> <span class="sc">*</span> rain)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.02263134 0.02726568 0.03281714 0.03945308 0.04736516 0.05677017
 [7] 0.06790956 0.08104689 0.09646267 0.11444547 0.13527876 0.15922259
[13] 0.18649040 0.21722152 0.25145143 0.28908330 0.32986526 0.37337882
[19] 0.41904309 0.46613767</code></pre>
</div>
</div>
<p>This gives us a predicted detection probability for each rainfall value. That’s useful, but a raw table of numbers wouldn’t be very effective in a thesis or presentation. It’s far clearer to visualise this relationship in a figure.</p>
<p>To do that, we combine the rainfall values and their corresponding predicted probabilities into a new dataset and then plot the relationship using <code>ggplot2</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  pred,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  rain</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> rain, <span class="at">y =</span> pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The resulting figure makes it much easier to interpret the model. We can now clearly see that detection probability increases with rainfall.</p>
<p>We can also tidy up the plot to make it more visually effective, by doing relatively small things like adjusting axis labels, converting probabilities to percentages, and applying a clean theme.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> rain, <span class="at">y =</span> pred)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean rainfall"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Predicted detection</span><span class="sc">\n</span><span class="st">probability of elephants"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="biological-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="biological-interpretation">Biological interpretation</h3>
<p>From the plot, it looks like elephants are more likely to be detected when it rains. If this were real data, we might start discussing ecological explanations. But here’s a key point:</p>
<p><strong>We should have thought about this before fitting the model.</strong></p>
<p>Interpreting results <em>after</em> seeing them and retroactively inventing explanations is risky. It’s called <em>HARKing</em>; <em>Hypothesising After the Results are Known</em> and it’s a form of scientific misconduct. It leads to misleading conclusions and reduces the credibility of research. Don’t do it. Even if it’s just for your own integrity.</p>
<p>Here, the data are simulated, so the stakes are low. The goal is to understand the modelling process. But in real research, it’s essential to define your question, hypotheses and state your predictions before doing the analysis. This starts going down the road of <em>pre-registration</em> but I won’t touch on that here.</p>
<p>So while visualising and interpreting your model is valuable, doing so responsibly is just as important.</p>
</section>
</section>
<section id="uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="uncertainty">Uncertainty</h2>
<p>The figure we created is a good start, but it’s missing something important: uncertainty.</p>
<p>If we were using frequentist statistics, we’d include 95% confidence intervals. But in the Bayesian framework, confidence intervals don’t exist. Instead, we use <em>credible intervals</em>.</p>
<p>Here’s the formal definition of a 95% <em>credible interval</em>:</p>
<blockquote class="blockquote">
<p>There is a 95% probability that the <strong>true</strong> parameter value lies within the interval range, given the data and model.</p>
</blockquote>
<p>This contrasts with frequentist confidence intervals, whose definition is more convoluted and often misunderstood. In fact, credible intervals behave exactly the way most people <em>think</em> confidence intervals do. I’ll explain the Bayesian framework more fully in a later section but for now, just trust me that credible intervals are more intuitive and arguably more useful.</p>
<section id="how-do-we-show-credible-intervals-on-our-figure" class="level3">
<h3 class="anchored" data-anchor-id="how-do-we-show-credible-intervals-on-our-figure">How do we show credible intervals on our figure?</h3>
<p>The model summary includes everything we need. The <code>2.5%</code> and <code>97.5%</code> columns from the summary output give us the lower and upper bounds of the credible interval for each parameter.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
PGOcc(occ.formula = ~1, det.formula = ~rain, data = etosha, n.samples = 2000, 
    verbose = FALSE, n.burn = 200, n.chains = 4)

Samples per Chain: 2000
Burn-in: 200
Thinning Rate: 1
Number of Chains: 4
Total Posterior Samples: 7200
Run Time (min): 0.0182

Occurrence (logit scale): 
              Mean     SD   2.5%   50%  97.5%   Rhat ESS
(Intercept) 1.8753 0.9465 0.3078 1.772 4.0465 1.0516 349

Detection (logit scale): 
               Mean     SD    2.5%     50%   97.5%   Rhat  ESS
(Intercept) -1.8872 0.2946 -2.4610 -1.8939 -1.2939 1.0165 1038
rain         0.6930 0.2384  0.2328  0.6877  1.1801 1.0025 2604</code></pre>
</div>
</div>
<p>To incorporate these into our plot, we repeat the prediction process we used earlier but this time, we use the lower and upper parameter estimates to calculate the corresponding detection probabilities. These will form the bounds of our uncertainty ribbon.</p>
<p>One important note: you do <strong>not</strong> need to multiply the standard error by 1.96 (as we did in BI3010). That approach belongs to the frequentist framework. With Bayesian models, we work directly with the posterior distributions and their quantiles, no extra calculation needed.</p>
<p>Let’s do just that:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>low <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">2.4610</span> <span class="sc">+</span> <span class="fl">0.2328</span> <span class="sc">*</span> df<span class="sc">$</span>rain)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>upp <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">1.2939</span> <span class="sc">+</span> <span class="fl">1.1801</span> <span class="sc">*</span> df<span class="sc">$</span>rain)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         pred        rain        low        upp
1  0.02263134 -2.71815687 0.04336427 0.01096960
2  0.02726568 -2.44127881 0.04611831 0.01514457
3  0.03281714 -2.16440076 0.04903828 0.02087495
4  0.03945308 -1.88752271 0.05213304 0.02871039
5  0.04736516 -1.61064465 0.05541172 0.03936862
6  0.05677017 -1.33376660 0.05888379 0.05376451
7  0.06790956 -1.05688855 0.06255900 0.07302436
8  0.08104689 -0.78001049 0.06644741 0.09846565
9  0.09646267 -0.50313244 0.07055932 0.13151304
10 0.11444547 -0.22625439 0.07490526 0.17351714
11 0.13527876  0.05062367 0.07949599 0.22545433
12 0.15922259  0.32750172 0.08434241 0.28752905
13 0.18649040  0.60437977 0.08945559 0.35877811
14 0.21722152  0.88125783 0.09484663 0.43685701
15 0.25145143  1.15813588 0.10052670 0.51819600
16 0.28908330  1.43501393 0.10650691 0.59858193
17 0.32986526  1.71189199 0.11279825 0.67399363
18 0.37337882  1.98877004 0.11941156 0.74135968
19 0.41904309  2.26564809 0.12635738 0.79895748
20 0.46613767  2.54252615 0.13364590 0.84638633</code></pre>
</div>
</div>
<p>Once we’ve calculated the lower and upper bounds, we can visualise the uncertainty using <code>geom_ribbon()</code> in <code>ggplot2</code>. This shaded area gives a clear, intuitive representation of the uncertainty around our predictions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> rain, <span class="at">y =</span> pred)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x =</span> rain, <span class="at">ymin =</span> low, <span class="at">ymax =</span> upp),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean rainfall"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Predicted detection</span><span class="sc">\n</span><span class="st">probability of elephants"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The result is a publication- or thesis-ready figure: a smooth line showing the predicted detection probability as rainfall increases, surrounded by a shaded band representing the credible interval.</p>
</section>
</section>
</section>
<section id="multiple-covariates" class="level1">
<h1>Multiple covariates</h1>
<p>Let’s increase the complexity by including multiple covariates in our simulation. We’ll assume that <em>tree height</em> and <em>average temperature</em> affect whether or not a site is occupied, where elephants prefer taller trees and cooler conditions. As before, <em>rainfall</em> will influence detection probability.</p>
<blockquote class="blockquote">
<p><strong>Technical note:</strong> To create the figures below, I needed to slightly restructure the data. The object used for plotting has one row per survey, with three surveys per site. The occupancy covariates (<code>tree</code> and <code>temp</code>) do not change across surveys, if a tree is 3 metres tall in survey one, it’s still 3 metres tall in surveys two and three. That’s why these variables are “recycled” or repeated across surveys.</p>
</blockquote>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">simOcc</span>(<span class="at">J.x =</span> <span class="dv">8</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">J.y =</span> <span class="dv">8</span>, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.rep =</span> <span class="fu">rep</span>(<span class="dv">3</span>, <span class="at">times =</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">8</span>), </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">beta =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.3</span>), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.5</span>))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> dat<span class="sc">$</span>y</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> dat<span class="sc">$</span>X[,<span class="dv">2</span>]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> dat<span class="sc">$</span>X[,<span class="dv">3</span>]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>det_cov <span class="ot">&lt;-</span> dat<span class="sc">$</span>X.p[,,<span class="dv">2</span>]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">survey =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="dv">64</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cov =</span> <span class="fu">c</span>(det_cov[,<span class="dv">1</span>], det_cov[,<span class="dv">2</span>], det_cov[,<span class="dv">3</span>]),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">rep</span>(tree, <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp =</span> <span class="fu">rep</span>(temp, <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(obs[,<span class="dv">1</span>], obs[,<span class="dv">2</span>], obs[,<span class="dv">3</span>])</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> temp)) <span class="sc">+</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Count"</span>, <span class="at">x =</span> <span class="st">"Temperature"</span>) <span class="sc">+</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">factor</span>(y), <span class="at">x =</span> temp),</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">height =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Temperature"</span>, <span class="at">y =</span> <span class="st">"Elephant</span><span class="sc">\n</span><span class="st">detection"</span>) <span class="sc">+</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> tree)) <span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Tree height"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">factor</span>(y), <span class="at">x =</span> tree),</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">height =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Tree"</span>, <span class="at">y =</span> <span class="st">"Elephant</span><span class="sc">\n</span><span class="st">detection"</span>) <span class="sc">+</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> cov)) <span class="sc">+</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Rain"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">factor</span>(y), <span class="at">x =</span> tree),</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">height =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Rain"</span>, <span class="at">y =</span> <span class="st">"Elephant</span><span class="sc">\n</span><span class="st">detection"</span>) <span class="sc">+</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>obs_long <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(obs)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(obs_long) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Survey_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(obs_long))</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Site <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(obs_long)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>obs_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(obs_long, </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Survey"</span>), </span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">names_to =</span> <span class="st">"Survey"</span>, </span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">values_to =</span> <span class="st">"Detection"</span>)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Survey <span class="ot">&lt;-</span> <span class="fu">factor</span>(obs_long<span class="sc">$</span>Survey, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"Survey_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(obs)))</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>obs_long<span class="sc">$</span>Detection <span class="ot">&lt;-</span> <span class="fu">factor</span>(obs_long<span class="sc">$</span>Detection, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Detection"</span>, <span class="st">"No detection"</span>))</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a> p7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(obs_long, <span class="fu">aes</span>(<span class="at">x =</span> Site, <span class="at">y =</span> Survey, <span class="at">fill =</span> Detection)) <span class="sc">+</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Detection"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"No detection"</span> <span class="ot">=</span> <span class="st">"lightgrey"</span>)) <span class="sc">+</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Site"</span>, <span class="at">y =</span> <span class="st">"Survey"</span>) <span class="sc">+</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a> design <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a><span class="st"> AB</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="st"> AB</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="st"> CD</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a><span class="st"> CD</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="st"> EF</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="st"> EF</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="st"> GG</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="st"> GG</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a><span class="st"> "</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4 <span class="sc">+</span> p5 <span class="sc">+</span> p6 <span class="sc">+</span> p7 <span class="sc">+</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>, <span class="at">tag_suffix =</span> <span class="st">")"</span>) <span class="sc">+</span> </span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_layout</span>(<span class="at">design =</span> design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<section id="what-do-the-figures-show" class="level3">
<h3 class="anchored" data-anchor-id="what-do-the-figures-show">What do the figures show?</h3>
<p>There are two important things to notice:</p>
<ol type="1">
<li><p><strong>Covariate types</strong><br>
In plots <strong>A)</strong> to <strong>D)</strong>, you’ll see that <em>temperature</em> and <em>tree height</em> do not vary from one survey to the next. These are constant within each site and are used as <em>site-level covariates</em> in the model.<br>
On the other hand, <strong>E)</strong> and <strong>F)</strong> show that <em>rainfall</em> does vary between surveys and between sites. This makes it a <em>survey-level covariate</em>.</p>
<blockquote class="blockquote">
<p><em>Note:</em> It’s technically possible to have site covariates that vary across time, but we’ll keep things simple here.</p>
</blockquote></li>
<li><p><strong>Misleading visual patterns</strong><br>
In plots <strong>B)</strong> and <strong>D)</strong> (temperature and tree height vs.&nbsp;detection), it’s hard to spot a clear relationship just by looking. That’s because not all zeros in detection are equal; some are true absences, and others are <em>false negatives</em>. In this simulation, we know which is which, but in real data we wouldn’t. The presence of false negatives hides the true relationship between covariates and elephant presence.</p></li>
</ol>
<p>This is exactly why we need a model.</p>
<p>Visual inspection can only take us so far, especially when detection is imperfect. We need a statistical model to help uncover the true patterns in the data.</p>
<p>Let’s get the data organised so we can fit that model.</p>
</section>
<section id="data-preparation-1" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation-1">Data preparation</h2>
<p>As before, we include our <em>survey covariates</em> as a <code>list</code>, while <em>site covariates</em> can be supplied as a <code>data.frame</code>. Both are then combined in another <code>list</code>, which is what we pass to the model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Survey covariate</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>det.covs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">rain =</span> dat<span class="sc">$</span>X.p[,,<span class="dv">2</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Site covariates</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>occ.covs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tree =</span> tree, <span class="at">temp =</span> temp)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a single list called etosha</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>etosha <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> dat<span class="sc">$</span>y, <span class="co"># Detection history</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">det.covs =</span> det.covs,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">occ.covs =</span> occ.covs</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fitting-the-model-1" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-1">Fitting the model</h2>
<p>The core model we’re fitting now includes two site covariates and one survey covariate:</p>
<p><span class="math display">\[z_i \sim Bernoulli(\psi_i)\]</span></p>
<p><span class="math display">\[logit(\psi_i) = \beta_0 + \beta_1 \times Tree_i + \beta_2 \times Temp_i\\\]</span></p>
<p><span class="math display">\[y_{i,j} \sim Bernoulli(p_{i,j} \times z_i)\\\]</span></p>
<p><span class="math display">\[logit(p_{i,j}) = \alpha_0 + \alpha_1 \times Rain_{i,j}\]</span></p>
<p>What’s important to notice here, aside from the inclusion of <code>Tree</code> and <code>Temp</code> in the state model, is the use of subscripts.</p>
<p>In the state model, the covariates are subscripted by <span class="math inline">\(i\)</span>, meaning each site has one value for <code>Tree</code> and <code>Temp</code>. In the observation model, <code>Rain</code> is subscripted by both <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, meaning it can vary between sites <em>and</em> surveys. This reflects how you’d record rainfall each time you visit a site.</p>
<p>Keep this in mind when collecting your own data:</p>
<ul>
<li><strong>Occupancy covariates</strong> usually vary by site, not by survey.</li>
<li><strong>Detection covariates</strong> typically vary by survey (i.e.&nbsp;time).</li>
</ul>
<p>That’s the general rule, but if you’re unsure or have an unusual situation, ask me.</p>
<p>To fit this model, we specify the occupancy formula as <code>~ tree + temp</code> and the detection formula as <code>~ rain</code>. The rest of the model setup (e.g.&nbsp;number of chains, samples, etc.) stays the same.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">PGOcc</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">occ.formula =</span> <span class="sc">~</span> tree <span class="sc">+</span> temp, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">det.formula =</span> <span class="sc">~</span> rain, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> etosha, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Details to get the machinery to run that we'll ignore for now</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.chains =</span> <span class="dv">4</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">2000</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.burn =</span> <span class="dv">200</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="interpreting-the-results" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-results">Interpreting the results</h2>
<p>Once the model has run, we can inspect the estimates using <code>summary()</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
PGOcc(occ.formula = ~tree + temp, det.formula = ~rain, data = etosha, 
    n.samples = 2000, verbose = FALSE, n.burn = 200, n.chains = 4)

Samples per Chain: 2000
Burn-in: 200
Thinning Rate: 1
Number of Chains: 4
Total Posterior Samples: 7200
Run Time (min): 0.0185

Occurrence (logit scale): 
               Mean     SD    2.5%     50%  97.5%   Rhat ESS
(Intercept)  1.9515 1.0600  0.1862  1.8333 4.2716 1.0441 347
tree         0.3649 1.2506 -2.0020  0.3180 2.8503 1.0383 293
temp        -1.1005 1.1484 -3.2573 -1.1617 1.3032 1.0452 277

Detection (logit scale): 
               Mean     SD    2.5%     50%   97.5%   Rhat  ESS
(Intercept) -1.8428 0.2636 -2.3606 -1.8424 -1.3199 1.0023 1404
rain         0.1730 0.2214 -0.2499  0.1707  0.6115 1.0023 2983</code></pre>
</div>
</div>
<p>We see that <code>tree</code> has a positive effect on occupancy (estimated at 0.3649), and <code>temp</code> has a negative effect (-1.1005). These estimates are in the general direction of the true values used in the simulation, though they’re not perfect:</p>
<ul>
<li><code>tree</code> was simulated at 0.3 and estimated at 0.37 (very close)</li>
<li><code>temp</code> was simulated at -0.2 but estimated at -1.1 (more of a difference)</li>
</ul>
<p>While the estimated relationship for <code>temp</code> is “correct” in that it gets the direction right (it’s a negative effect), it’s kind of far away from the true value that was specified in the simulation. That’s where <em>credible intervals</em> become useful. Remember, a 95% credible interval means there’s a 95% chance the true parameter lies within that range. In our case, the true values for both <code>tree</code> and <code>temp</code> do fall within their respective 95% credible intervals. This is good, it tells us the model reflects its uncertainty accurately, which is especially important with small sample sizes or subtle effects.</p>
</section>
<section id="diagnosing-potential-issues" class="level2">
<h2 class="anchored" data-anchor-id="diagnosing-potential-issues">Diagnosing potential issues</h2>
<p>There are two early warning signs that suggest this model might not be performing optimally:</p>
<ol type="1">
<li><p><strong>Rhat values</strong><br>
The Rhat values for the <code>Occurrence</code> parameters are getting close to 1.05. While they haven’t crossed the danger threshold, they’re high enough to warrant attention. My personal rule of thumb is to start worrying around 1.05.</p></li>
<li><p><strong>Effective Sample Size (ESS)</strong><br>
The ESS for the <code>Occurrence</code> parameters is noticeably lower than for the detection parameters. While we still have several hundred samples, which is generally acceptable, it’s another flag that suggests the model might benefit from refinement.</p></li>
</ol>
<p>In our first model earlier on the previous page (the intercept only occupancy model), we ignored these diagnostics (in part because there were no issues). This time, we’ll see if we can address them to improve model performance.</p>
</section>
<section id="resolving-issues" class="level2">
<h2 class="anchored" data-anchor-id="resolving-issues">Resolving issues</h2>
<p>To fully understand how to resolve issues like high <code>Rhat</code> or low <code>ESS</code> values requires a deeper dive into Bayesian statistics. We’ll save that for a later section. For now, here’s a simplified explanation:</p>
<p>The Bayesian framework relies on algorithms, called <em>chains</em>, that take many <em>iterations</em> (or guesses) to estimate the most likely values of the model parameters.</p>
<p>The two metrics we use to assess how well this process is working are:</p>
<ul>
<li><em><code>Rhat</code></em>: Tells us whether the different chains agree with each other (or have <em>converged</em> to more-or-less the same answer). Higher values suggest poor convergence.</li>
<li><em><code>ESS</code> (Effective Sample Size)</em>: Indicates how well the parameter was estimated. Lower values suggest greater uncertainty or inefficiency.</li>
</ul>
<p>If <code>Rhat</code> values are high or <code>ESS</code> values are low, one common fix is to increase the number of iterations. This gives the algorithms more opportunities to find consistent and stable parameter estimates.</p>
<p>So let’s do just that: we increase the total number of iterations to 3000 per chain, and slightly increase the number of burn-in iterations (guesses that we ignore from when the algorithm starts) to account for that change.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">PGOcc</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">occ.formula =</span> <span class="sc">~</span> tree <span class="sc">+</span> temp, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">det.formula =</span> <span class="sc">~</span> rain, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> etosha, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We're using four chains/algorithms</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.chains =</span> <span class="dv">4</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We allow 3000 guesses (increased from 2000)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">3000</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We ignore the first 300 (increased from 200)</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We ignore them because we assume the algorithms are not particularly reliable</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the first ca. 10% of guesses</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.burn =</span> <span class="dv">300</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After running the model again, we can check the summary output. If all goes well, we hope to see:</p>
<ul>
<li><code>Rhat</code> values closer to 1</li>
<li>Higher <code>ESS</code> values for the occupancy parameters</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
PGOcc(occ.formula = ~tree + temp, det.formula = ~rain, data = etosha, 
    n.samples = 3000, verbose = FALSE, n.burn = 300, n.chains = 4)

Samples per Chain: 3000
Burn-in: 300
Thinning Rate: 1
Number of Chains: 4
Total Posterior Samples: 10800
Run Time (min): 0.0268

Occurrence (logit scale): 
               Mean     SD    2.5%     50%  97.5%   Rhat ESS
(Intercept)  1.9586 1.0113  0.1496  1.8785 4.0979 1.0061 533
tree         0.3562 1.2971 -2.0341  0.3101 2.9698 1.0498 415
temp        -1.2475 1.0628 -3.3183 -1.2672 0.9406 1.0176 470

Detection (logit scale): 
               Mean     SD    2.5%     50%   97.5%   Rhat  ESS
(Intercept) -1.8461 0.2664 -2.3631 -1.8497 -1.3123 1.0014 1625
rain         0.1791 0.2196 -0.2462  0.1772  0.6243 1.0016 4411</code></pre>
</div>
</div>
<p>Now when we look at the <code>Rhat</code> and <code>ESS</code> values, we are doing better. Still not perfect but good enough for me to be happy that <em>by these two metrics alone</em> there’s nothing to suggest the machinery is struggling and that the parameters are being estimated as robustly as possible.</p>
<p>This won’t always fix every problem, but in many cases it’s a simple and effective first step.</p>
<blockquote class="blockquote">
<p>Note: <code>Rhat</code> and <code>ESS</code> are not the only diagnostics we can use. In a later section, we’ll explore other ways to assess how well our model is performing.</p>
</blockquote>
<p>For now, based on these two metrics, we’re happy that the model has converged and is estimating parameters robustly. We can now move on to plotting the predicted relationships.</p>
</section>
<section id="plot-predicted-relationships-1" class="level2">
<h2 class="anchored" data-anchor-id="plot-predicted-relationships-1">Plot predicted relationships</h2>
<p>Previously, we generated predictions by hand using parameter estimates and “manual” calculations. This time, we’ll (kind of) simplify things by using the <code>predict()</code> function, which does most of the heavy lifting for us. The overall process is still the same:</p>
<ol type="1">
<li>Create a “fake” dataset with covariate values for which we want predictions.</li>
<li>Apply the model to these values to generate predicted responses.</li>
<li>Convert logit values to probabilities.</li>
<li>Plot the predicted probabilities against covariate values to show the relationship.</li>
</ol>
<p>Remember, occupancy models are essentially two connected Bernoulli GLMs. When using <code>predict()</code>, we must specify which part of the model we’re predicting from: <code>occupancy</code> or <code>detection</code>.</p>
<p>Normally, when plotting the effect of one covariate (e.g.&nbsp;<code>tree</code>), we hold the other covariates constant—typically at their median values, just like you did in BI3010.</p>
<p>However, for these models there are a few extra (annoying) things we need to do and for me to explain here. As a warning some of these get quite technical. It might be a good time to take a break and come back when you’re fresh.</p>
<p>However, with <code>spOccupancy</code>, there are a few additional steps involved. Some are a bit technical, so if you’re feeling tired, it might be a good point to pause and return later. If you’re confused by anything below, don’t worry, we can talk it through in person.</p>
<section id="model-matrix" class="level3">
<h3 class="anchored" data-anchor-id="model-matrix">Model matrix</h3>
<p>To make predictions, we need to pass a <em>design matrix</em> to the <code>predict()</code> function. This is done using <code>model.matrix()</code>. It turns your covariate data (like <code>tree</code> and <code>temp</code>) into the format expected by the model, where each column represents a variable, and each row represents a combination of covariate values.</p>
<p>When we fit a model using <code>~ tree + temp</code>, R internally builds a model matrix. When predicting, we must do the same so the structure matches.</p>
</section>
<section id="qlogis-and-plogis" class="level3">
<h3 class="anchored" data-anchor-id="qlogis-and-plogis"><code>qlogis</code> and <code>plogis</code></h3>
<p>The <code>predict()</code> function returns thousands of posterior draws for each site’s occupancy or detection probability. These are already on the probability scale (i.e.&nbsp;backtransformed from the logit scale).</p>
<p>However, there’s a subtle issue here. If we summarise these probability values directly (e.g.&nbsp;take their mean or credible intervals), the result can sometimes be misleading, especially if the underlying uncertainty is skewed. The shape of the probability distribution can become distorted and give odd patterns (like artificial peaks or dips).</p>
<p>To avoid this, when working with <code>spOccupancy</code>, we need to:</p>
<ol type="1">
<li>Transform probabilities <em>back</em> to the logit scale using <code>qlogis()</code>.</li>
<li>Summarise the posterior draws on the logit scale (mean and credible intervals).</li>
<li>Transform the summaries <em>back</em> to probabilities using <code>plogis()</code>.</li>
</ol>
<p>This avoids distortion and produces smoother, more reliable estimates.</p>
</section>
<section id="apply" class="level3">
<h3 class="anchored" data-anchor-id="apply"><code>apply()</code></h3>
<p>The posterior samples are structured with one row per iteration (i.e.&nbsp;per guess) and one column per site. To summarise across iterations for each site, we use <code>apply()</code> with <code>MARGIN = 2</code> (i.e.&nbsp;apply the function across columns). We calculate the mean, lower (2.5%), and upper (97.5%) quantiles for each.</p>
<p>Honestly, the code is more complex than I would like. I wish I could think of a simpler way to do it (and I might ask my wife, who’s better at coding than me, to see if she can improve it) but this is the best I can do for now. Speak to me if you need help.</p>
</section>
<section id="plotting-predictions" class="level3">
<h3 class="anchored" data-anchor-id="plotting-predictions">Plotting predictions</h3>
<p>We can now generate prediction curves for each covariate in our model:</p>
<ul>
<li><p><em>Tree height</em> (site-level covariate affecting occupancy): Create a range of values for <code>tree</code>, hold <code>temp</code> at its median, predict, summarise, and plot.</p></li>
<li><p><em>Temperature</em> (another site-level covariate): Hold <code>tree</code> at its median and repeat the steps above for <code>temp</code>.</p></li>
<li><p><em>Rainfall</em> (survey-level covariate affecting detection): Generate a sequence of rainfall values and repeat the prediction and summarisation steps for detection probability.</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tree height ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a new fake data frame for tree (hold temp at median)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">seq</span>(<span class="fu">min</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>tree), <span class="fu">max</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>tree), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp =</span> <span class="fu">median</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>temp)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Convert this into a model matrix</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>X<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> tree <span class="sc">+</span> temp, <span class="at">data =</span> fake)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Predict occupancy from model matrix</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>pred_occ <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">X.0 =</span> X<span class="fl">.0</span>, <span class="at">type =</span> <span class="st">"occupancy"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Transform back into logit values</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>logit_psi_samples <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(pred_occ<span class="sc">$</span>psi.<span class="fl">0.</span>samples)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Summarize the posteriors</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> fake<span class="sc">$</span>tree,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.psi =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, mean),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>)),</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Backtransform into probabilities</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> fake<span class="sc">$</span>tree,</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.psi =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>mean.psi),</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>lower),</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>upper)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Plot</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fake, <span class="fu">aes</span>(<span class="at">x =</span> tree, <span class="at">y =</span> mean.psi)) <span class="sc">+</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Tree height"</span>, <span class="at">y =</span> <span class="st">"Occupancy probability (ψ)"</span>) <span class="sc">+</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean temperature ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a new data frame for temp (hold tree at median)</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">median</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>tree),</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp =</span> <span class="fu">seq</span>(<span class="fu">min</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>temp), <span class="fu">max</span>(etosha<span class="sc">$</span>occ.covs<span class="sc">$</span>temp), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Convert this into a model matrix</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>X<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> tree <span class="sc">+</span> temp, <span class="at">data =</span> fake)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Predict occupancy from model matrix</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>pred_occ <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">X.0 =</span> X<span class="fl">.0</span>, <span class="at">type =</span> <span class="st">"occupancy"</span>)</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Transform back into logit values</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>logit_psi_samples <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(pred_occ<span class="sc">$</span>psi.<span class="fl">0.</span>samples)</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Summarize the posteriors</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp =</span> fake<span class="sc">$</span>temp,</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.psi =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, mean),</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>)),</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">apply</span>(logit_psi_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Backtransform into probabilities</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp =</span> fake<span class="sc">$</span>temp,</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.psi =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>mean.psi),</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>lower),</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>upper)</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Plot</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fake, <span class="fu">aes</span>(<span class="at">x =</span> temp, <span class="at">y =</span> mean.psi)) <span class="sc">+</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Temperature"</span>, <span class="at">y =</span> <span class="st">"Occupancy probability (ψ)"</span>) <span class="sc">+</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Rain fall ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a new data frame for temp (hold tree at median)</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">rain =</span> <span class="fu">seq</span>(<span class="fu">min</span>(etosha<span class="sc">$</span>det.covs<span class="sc">$</span>rain), <span class="fu">max</span>(etosha<span class="sc">$</span>det.covs<span class="sc">$</span>rain), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Convert this into a model matrix</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>X<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> rain, <span class="at">data =</span> fake)</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Predict occupancy from model matrix</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>pred_det <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">X.0 =</span> X<span class="fl">.0</span>, <span class="at">type =</span> <span class="st">"detection"</span>)</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Transform back into logit values</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>logit_p_samples <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(pred_det<span class="sc">$</span>p.<span class="fl">0.</span>samples)</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Summarize the posteriors</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">rain =</span> fake<span class="sc">$</span>rain,</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.p =</span> <span class="fu">apply</span>(logit_p_samples, <span class="dv">2</span>, mean),</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">apply</span>(logit_p_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>)),</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">apply</span>(logit_p_samples, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Backtransform into probabilities</span></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>fake <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>  <span class="at">rain =</span> fake<span class="sc">$</span>rain,</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.p =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>mean.p),</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>lower),</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">plogis</span>(fake<span class="sc">$</span>upper)</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Plot</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fake, <span class="fu">aes</span>(<span class="at">x =</span> rain, <span class="at">y =</span> mean.p)) <span class="sc">+</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Rainfall"</span>, <span class="at">y =</span> <span class="st">"Detection probability (p)"</span>) <span class="sc">+</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a><span class="st">AB</span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a><span class="st">CC</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">design =</span> design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="OccMods_WithCovariates_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="how-should-i-store-my-data" class="level1">
<h1>How should I store my data?</h1>
<p>The data storage required for occupancy models can feel a bit complicated at first. A good starting point is to organise your data into at least <em>three separate datasets</em>, each with a specific purpose.</p>
<section id="dataset-one-detection-history" class="level2">
<h2 class="anchored" data-anchor-id="dataset-one-detection-history">Dataset one: Detection history</h2>
<p>This dataset records whether or not the species was detected during each survey at each site.</p>
<p>Create an Excel sheet where <strong>rows are sites (or cameras)</strong> and <strong>columns are survey periods</strong>. For example, if your sampling unit is a 12-hour period and you have three surveys per site, your dataset might look like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>dh <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1"</span> <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.3</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2"</span> <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3"</span> <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">50</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.4</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(dh, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item" id="htmlwidget-6a5b8e28d95e624543d1" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-6a5b8e28d95e624543d1">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],[1,0,0,1,1,1,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,1,1,0,0,0,0,0,1,0,1,1,0,0],[1,1,0,0,0,0,1,0,0,0,1,0,1,1,1,0,1,1,0,1,1,1,1,1,0,0,1,0,0,0,1,0,0,1,0,1,1,0,1,1,1,1,0,0,0,0,1,1,0,1],[0,0,1,1,0,0,1,0,0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,0,0,1,1,1,0,1,1,0,0,0,1,0,0,0,1,1,0,1,0,0,0,0,0,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>3<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"1","targets":1},{"name":"2","targets":2},{"name":"3","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<ul>
<li>Row 1: Site 1 detections for surveys 1, 2, 3<br>
</li>
<li>Row 2: Site 2 detections for surveys 1, 2, 3<br>
</li>
<li>etc.</li>
</ul>
<p>Each cell should be a <code>1</code> (detection) or <code>0</code> (no detection).</p>
</section>
<section id="dataset-two-site-level-covariates" class="level2">
<h2 class="anchored" data-anchor-id="dataset-two-site-level-covariates">Dataset two: Site-level covariates</h2>
<p>This dataset contains all of your <strong>site covariates</strong>, variables that do not change from one survey to the next. These should be organised in the <strong>same order</strong> as your detection history dataset.</p>
<blockquote class="blockquote">
<p><strong>This is crucial.</strong> If site 1 is the first row in your detection history, it must also be the first row here. Check and double-check that the site ordering is consistent across files.</p>
</blockquote>
<p>Each covariate should be a column. For example:</p>
<ul>
<li>Distance to nearest road<br>
</li>
<li>Distance to nearest release pen<br>
</li>
<li>Habitat type</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">road =</span> <span class="fu">round</span>(<span class="fu">rgamma</span>(<span class="dv">50</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pen =</span> <span class="fu">round</span>(<span class="fu">rgamma</span>(<span class="dv">50</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="at">digits =</span> <span class="dv">1</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">habitat =</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">50</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Forest"</span>, <span class="st">"Field"</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item" id="htmlwidget-3591f1c01266d8b71d79" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3591f1c01266d8b71d79">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],[0.266,0.212,1.84,0.844,0.023,0.63,0.212,1.082,0.032,0.6,0.6899999999999999,0.902,0.491,0.301,0.155,1.073,1.296,0.474,0.495,0.774,0.029,0.505,0.271,0.386,0.01,0.8139999999999999,0.27,0.946,0.22,0.485,1.123,0.82,0.6820000000000001,0.844,1.054,1.511,0.056,0.324,0.196,0.345,0.433,1.509,0.218,0.472,1.071,0.017,0.063,0.211,0.262,0.011],[0.5,0.8,0.3,0,0.2,0.2,1,0.2,1,0.4,1.2,0.2,0.3,0.6,0.4,0.5,1.1,1.7,0.2,0.4,0.7,0.4,1,1.2,0.2,0.4,0.1,0.7,0.5,0.2,0.8,0.5,0.4,0.2,1,0.8,0.2,1.5,0.6,0.6,0.3,0.2,0.4,0.6,0.5,0.3,2.6,0.4,0.3,1.4],["Field","Forest","Field","Forest","Forest","Field","Field","Field","Field","Field","Forest","Field","Field","Forest","Forest","Forest","Field","Field","Field","Forest","Forest","Field","Forest","Field","Forest","Forest","Field","Forest","Field","Forest","Forest","Forest","Field","Forest","Forest","Field","Field","Forest","Forest","Field","Forest","Field","Forest","Forest","Field","Field","Forest","Forest","Field","Forest"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>road<\/th>\n      <th>pen<\/th>\n      <th>habitat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"road","targets":1},{"name":"pen","targets":2},{"name":"habitat","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="dataset-three-and-beyond-survey-level-covariates" class="level2">
<h2 class="anchored" data-anchor-id="dataset-three-and-beyond-survey-level-covariates">Dataset three (and beyond): Survey-level covariates</h2>
<p>Each <strong>survey covariate</strong> needs its own Excel file. These files are structured like your detection history:</p>
<ul>
<li>Rows are sites<br>
</li>
<li>Columns are surveys</li>
</ul>
<p>This setup allows each covariate to vary by site and by survey, which is essential when fitting more realistic detection models.</p>
<p>For example, you might have a dataset that records average light pollution on each survey:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1"</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2"</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3"</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item" id="htmlwidget-75c7fe0db3d78887d01f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-75c7fe0db3d78887d01f">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],[0.2293655012004598,0.2562649354003344,2.210148507202776,0.4784911138833739,0.5087513285936826,-1.245646532280894,-0.3067552782313552,-1.723762898987013,-0.7598762784723017,-0.1381806971399123,-0.2840862633064474,0.2800222889848699,-1.37736481952349,-0.5775563038359111,0.6589854103832662,0.3081195275506381,1.185036895733731,1.387952627149431,-0.5760394268892862,-0.8727836192198231,1.160528058377827,-1.816533693564834,0.9359386978044987,-0.2304174365356287,-1.657102435730096,-0.1676173987294588,-0.3100759904495194,-0.768983667289694,1.538887818782219,-1.852343830617509,-1.199469594661844,0.235699141474781,0.5867329233699112,0.1957465438443483,0.788648351587648,-0.8920737262604063,0.2655212805099271,-0.2703962195365305,-0.6181205691033658,-0.4240738466643515,-0.2228367254222793,-0.2525944220556619,1.001196165349516,-1.004756590779265,0.7664882871283322,0.2715543397240473,0.654420890965258,-0.3128823269134357,-0.7966485493832036,-1.965402894447587],[2.689520335617337,3.373445050680552,-2.259229936568228,1.466762624378569,0.3471266331250371,0.7735652275666967,-0.2590769596933531,-0.9554017258154965,1.866602622480088,0.4882489635900076,2.234815034721655,0.9858194731162307,-0.7207348352957601,2.606032076927535,0.09895123845243714,-0.3539615283026643,0.05050832560432716,-1.639431260891807,-1.509550604945179,1.667570910792038,0.3478299196648297,1.02065143340677,1.470299672513831,-0.07787235680317761,3.546348301452596,-0.378239719111148,1.251073953424307,0.7533518426303603,2.252763785806368,0.9551311847576159,-2.228838811088905,0.8543237926456472,-1.285284543946215,-2.749243765535602,0.009626973198144761,-3.214255777836883,1.620925269982636,3.221323877450984,-2.102657330655428,-1.623227671565014,0.5889703197112496,3.992919725674034,-1.519005900153489,0.07919595555984926,2.909539802048921,-0.3660431913874944,3.099591449833732,1.649378999571582,0.8055752159222866,-0.08890084391110875],[0.1999422975136491,-1.658484277742144,-0.4121695391491023,-0.8330429415593303,-1.811531577526425,-1.211851092326426,-0.9380926945255909,-0.3314929825500275,-1.840392999472996,0.9677114737202384,-0.8811824892072183,0.8295583221627918,1.716168105804098,-4.260452567681076,-1.633760829100741,-2.11699956353783,-1.136865066589407,-1.232283193402298,-2.425627697002127,-1.749821693173311,-1.250246855476306,0.2012993231158682,-1.023704044901491,-2.245136301240478,-2.433803974163912,-0.9654371481078597,-1.898384944183613,-0.8152507435768203,0.1236037826585847,0.2556086229303307,0.6809953394557005,0.1649316309489064,-1.142974180416556,-1.299033748624452,-2.03753083911366,-2.72968188495069,-2.355354180823692,-1.506959784612026,-1.517208809324141,-1.020464544207848,-2.288722703543259,-1.574133557315073,-1.281616732822917,-0.5784287427706326,0.1022524284002715,-0.2282021927341882,-0.5543339446021155,-0.5189931822167965,-0.3319943011806417,-1.572968479445394]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>3<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"1","targets":1},{"name":"2","targets":2},{"name":"3","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>But if you were also collecting data on if a field was being ploughed or not you may have:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">50</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Plough"</span>, <span class="st">"No plough"</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">50</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Plough"</span>, <span class="st">"No plough"</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">50</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Plough"</span>, <span class="st">"No plough"</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item" id="htmlwidget-5c0a65429d1e77b784fb" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-5c0a65429d1e77b784fb">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["Plough","No plough","No plough","No plough","Plough","No plough","Plough","No plough","No plough","No plough","Plough","No plough","Plough","No plough","No plough","No plough","Plough","No plough","Plough","No plough","Plough","Plough","Plough","Plough","Plough","Plough","No plough","No plough","No plough","Plough","Plough","No plough","Plough","Plough","No plough","Plough","Plough","Plough","Plough","Plough","No plough","No plough","Plough","No plough","No plough","No plough","Plough","No plough","Plough","No plough"],["No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","No plough","Plough","No plough","No plough","No plough","No plough","No plough","No plough","Plough","No plough","No plough","No plough","Plough","No plough","Plough","No plough","Plough","No plough","Plough","No plough","Plough","No plough","Plough","No plough","Plough","No plough","No plough","Plough"],["Plough","Plough","No plough","Plough","Plough","Plough","Plough","Plough","No plough","Plough","Plough","Plough","Plough","No plough","Plough","Plough","Plough","No plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","Plough","No plough","Plough","Plough","No plough","No plough","Plough","Plough","Plough","Plough","No plough","Plough","Plough","Plough","Plough","Plough","Plough","No plough","Plough","Plough"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>1<\/th>\n      <th>2<\/th>\n      <th>3<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"1","targets":1},{"name":"2","targets":2},{"name":"3","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="what-next" class="level1">
<h1>What next?</h1>
<p>Hopefully this page gave you a clearer understanding of the theory, how to implement occupancy models in practice, and how to collect and store your data correctly.</p>
<p>On the next page, we’ll begin thinking about <em>Bayesian</em> statistics.</p>
<p>But before that, take a break. Go for a walk, close the laptop, and come back in a day or two. When you’re ready, we’ll dive into how the Bayesian framework works, and why it underpins everything we’ve done so far.</p>
</section>
<section id="lecture-recording" class="level1">
<h1>Lecture recording</h1>
<p>Unlike on the previous page, I don’t have a lecture recording a a single-season occupancy model that includes covariates. The lecture below does include covariates, but for models when you have multiple seasons. So a lot of the lecture won’t be directly related to your thesis, other than where I talk about how to include covariates. Sorry for that!</p>
<iframe src="https://abdn.cloud.panopto.eu/Panopto/Pages/Embed.aspx?id=5cfbf4bd-b968-42ad-bd26-acb7010aa806" width="720" height="405" allowfullscreen="">
</iframe>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>